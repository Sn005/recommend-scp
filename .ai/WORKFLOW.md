# 仕様駆動開発（SDD）ワークフロー

## 概要

このドキュメントは、AI駆動開発における標準ワークフローを定義します。
人間とAIが協調して、仕様に基づいた品質の高い開発を行うためのガイドラインです。

---

## 2つのワークフロー

本SDDフレームワークは、**上流（仕様策定）** と **下流（実装）** の2つのワークフローで構成されます。

```
┌─────────────────────────────────────────────────────────────┐
│                    開発ライフサイクル                         │
├─────────────────────────────────────────────────────────────┤
│  【上流】仕様策定フェーズ          【下流】実装フェーズ        │
│  ┌─────────────────────┐     ┌─────────────────────┐       │
│  │ /spec               │ ──→ │ spec-workflow       │       │
│  │ (仕様策定Skill)      │     │ (実装Skill)         │       │
│  │                     │     │                     │       │
│  │ ・要件ヒアリング      │     │ ・AC確認            │       │
│  │ ・EARS記法でAC生成   │     │ ・TDD実行           │       │
│  │ ・設計ドキュメント作成 │     │ ・スコープ管理      │       │
│  │ ・EPIC/Story/Subtask │     │ ・完了確認          │       │
│  │   ファイル生成       │     │                     │       │
│  └─────────────────────┘     └─────────────────────┘       │
│                                                             │
│  トリガー:                      トリガー:                    │
│  「specを作成して」              「実装して」                 │
│  「仕様を策定して」              「開発して」                 │
│  「[機能名]のspecを書いて」       「Subtask開始」              │
└─────────────────────────────────────────────────────────────┘
```

### 使い分け

| ワークフロー | 用途 | 入力 | 出力 |
|-------------|------|------|------|
| `/spec` | 新機能の仕様策定 | 自然言語の要件 | EPIC/Story/Subtaskファイル |
| `spec-workflow` | 仕様に基づく実装 | Subtaskファイル | テスト済みコード |

---

## 基本原則

### 1. 仕様ファースト

- 実装前に必ず仕様（EPIC/Story/Subtask）を確認
- ACを満たすことが完了の唯一の基準
- スコープ外の実装は禁止（提案は可）

### 2. テスト駆動（TDD）

- ACからテストケースを導出
- Red → Green → Refactor サイクルを厳守
- テストなしの実装は禁止

### 3. 段階的完了

- Subtask → Story → EPICの順で完了
- 親が完了するには全ての子が完了している必要がある
- 完了時は即座にステータスを更新

---

## ワークフロー詳細

### Phase 1: Subtask開始前

```
┌─────────────────────────────────────────────────┐
│  1. 該当Subtaskのファイルを読み込む              │
│     specs/{epic-id}/{story-id}/{subtask-id}.md  │
│                                                 │
│  2. ユーザーストーリーを確認                    │
│     - ペルソナ（誰のため？）                    │
│     - 目的（何をする？）                        │
│     - 価値（なぜ重要？）                        │
│                                                 │
│  3. ACを確認                                    │
│     - 完了条件は何か？                          │
│     - テストケースに変換できるか？              │
│                                                 │
│  4. ユーザーに確認                              │
│     「このACで実装を進めますか？」              │
└─────────────────────────────────────────────────┘
```

### EARS記法によるAC確認

ACがEARS記法で記述されている場合、以下の構造を理解してからテストケースを導出します。

```
EARS記法パターン:
┌─────────────────────────────────────────────────┐
│  WHEN [トリガー・状況]                          │
│  GIVEN [前提条件]                               │
│  THEN [期待動作]                                │
│  AND [追加動作]                                 │
└─────────────────────────────────────────────────┘

テストケースへの変換例:
┌─────────────────────────────────────────────────┐
│  AC:                                            │
│  WHEN ユーザーがログインを試行する際            │
│  GIVEN 有効なメールとパスワードを入力した場合   │
│  THEN システムはJWTトークンを発行する           │
│  AND ダッシュボードにリダイレクトする           │
│                                                 │
│  ↓ テストケース:                                │
│                                                 │
│  describe('ログイン', () => {                   │
│    it('有効な認証情報でJWTが発行される', () => {│
│      // GIVEN: 前提条件をセットアップ           │
│      // WHEN: トリガーを実行                    │
│      // THEN: 期待結果を検証                    │
│    });                                          │
│  });                                            │
└─────────────────────────────────────────────────┘
```

---

### Phase 2: TDD実装

```
┌─────────────────────────────────────────────────┐
│  🔴 Red: テストを先に書く                       │
│     - ACからテストケースを導出                  │
│     - EARS記法の場合はGIVEN/WHEN/THENを活用     │
│     - テストが失敗することを確認                │
│                                                 │
│  🟢 Green: 最小限の実装                         │
│     - テストを通すための最小限のコード          │
│     - ACの範囲内のみ実装                        │
│     - スコープ外は実装しない                    │
│                                                 │
│  🔵 Refactor: コード改善                        │
│     - テストが通ることを保ちながら改善          │
│     - 重複排除、可読性向上                      │
└─────────────────────────────────────────────────┘
```

### Phase 3: 完了確認

```
┌─────────────────────────────────────────────────┐
│  1. AC全項目をチェック                          │
│     - [ ] → [x] に更新                          │
│                                                 │
│  2. テストが全て通過することを確認              │
│                                                 │
│  3. ステータス更新                              │
│     - status: "completed"                       │
│     - completed_at: "YYYY-MM-DD"                │
│                                                 │
│  4. 親Storyの確認                               │
│     - 全Subtask完了 → Story完了                 │
│     - 全Story完了 → EPIC完了                    │
│                                                 │
│  5. 次のSubtaskを提示                           │
└─────────────────────────────────────────────────┘
```

---

## スコープ管理

### スコープ内（実装OK）

- ACに明記されている機能
- ACを達成するために必須の技術的実装
- ユーザーストーリーの価値を実現する機能

### スコープ外（実装NG、提案のみ）

- ACに記載のない「ついでに」の改善
- 将来必要になる「かもしれない」機能
- 他のSubtask/Storyで対応すべき機能

### スコープ判断の例

```
AC: 「ユーザー認証APIを実装すること」

✅ スコープ内:
- JWTトークン発行・検証
- ログインエンドポイント
- 認証ミドルウェア

❌ スコープ外（提案のみ）:
- OAuth連携（ACに記載なし）
- パスワードリセット（別Subtask）
- 管理者ロール機能（将来機能）
```

---

## チェックリスト

### Subtask開始前チェックリスト

- [ ] 該当Subtaskのファイルを読み込んだ
- [ ] ユーザーストーリーを確認した
- [ ] ACを理解した
- [ ] テストケースを導出した
- [ ] ユーザーに確認した

### 実装中チェックリスト

- [ ] テストを先に書いた（Red）
- [ ] 最小限の実装をした（Green）
- [ ] コードを改善した（Refactor）
- [ ] ACの範囲内のみ実装した
- [ ] スコープ外の実装はしていない

### 完了時チェックリスト

- [ ] 全ACがチェックされている
- [ ] 全テストが通過している
- [ ] ステータスを "completed" に更新した
- [ ] completed_at を記入した
- [ ] 次のSubtaskをユーザーに提示した

---

## エラーハンドリング

### ACが曖昧な場合

1. 実装を開始しない
2. ユーザーにAC明確化を依頼
3. ACが明確になってから実装開始

### スコープ外の依頼を受けた場合

1. スコープ外であることを説明
2. 別Subtask/Storyとして提案
3. ユーザーが承諾したら新規仕様を作成

### テストが通らない場合

1. 実装を修正（Green達成まで）
2. テスト自体の問題なら修正
3. ACの解釈に問題があればユーザーに確認

---

## ファイル操作ガイドライン

### 読み込むファイル

| タイミング | ファイル |
|-----------|----------|
| Subtask開始時 | `specs/{epic-id}/{story-id}/{subtask-id}.md` |
| 参照が必要な時 | `specs/{epic-id}/{story-id}/{story-id}.md`, `specs/{epic-id}/{epic-id}.md` |
| ワークフロー確認時 | `.ai/WORKFLOW.md` |

### 更新するファイル

| タイミング | ファイル | 更新内容 |
|-----------|----------|----------|
| 完了時 | `specs/{epic-id}/{story-id}/{subtask-id}.md` | status, completed_at, ACチェック |
| 全Subtask完了時 | `specs/{epic-id}/{story-id}/{story-id}.md` | status, completed_at |
| 全Story完了時 | `specs/{epic-id}/{epic-id}.md` | status, completed_at |

---

## コミュニケーションガイドライン

### ユーザーへの確認が必要な場合

- ACが曖昧または不足している
- 複数の実装方法が考えられる
- スコープ外の機能が必要になった
- 技術的な制約が発見された

### 報告すべき内容

- 各フェーズ（Red/Green/Refactor）の完了
- ACの達成状況
- 発見した問題点
- 次のSubtaskの提案

---

## 禁止事項

- ACなしでの実装開始
- テストなしでの実装
- スコープ外の「ついでに」実装
- 完了確認なしのステータス更新
- ユーザー確認なしのAC変更
